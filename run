#!/usr/bin/env nu
 
def "main web" [] {
  let server_port = (port 8080);
  $server_port out> ./site/src/port.txt
  cd ours
  cargo build 
  job spawn {
    cargo run -- ~/ $server_port
  }
  cd ../site/
  trunk serve --port (port 1024) --open
}

def "main desk" [] {
  cd ours/
  cargo run
}

def "main build" [target? : string] {
  mut args = "" 
  if $target != null {
    $args = $"--target=($target)"
  }
  cd ./site
  trunk build --release
  cd ..
  ls site_assets/gen | get name | par-each {|x| gzip $x} 
  cd ours
  cargo build $args --release
}

def "main install" [] {
  main build 
  cargo install --path ./ours
}

def main [] {}
